---
title: "Loan Prediction"
author: "Aditya Sinha, Alex von Schwerdtner, Fusu Luo, Jennifer Horita , Weijia Suo"
output: html_notebook
---

```{r}
installed.packages(c("data.table", "ggplot2", "ggthemes", "scales", "ISLR"))
```

```{r}
library(data.table)
library(ggplot2)
library(ggthemes)
library(scales)
library(ISLR)
```

```{r}
dd <- fread("./Training-Data.csv")
head(dd,n=10)
```

---
EDA: Income
---

```{r}
print(paste0("Minimum salary: ",min(dd$Income)))
print(paste0("Maximum salary: ",max(dd$Income)))
```

```{r}
salary_distribution <- ggplot(dd, aes(dd$Income, fill=..count..))+
  geom_histogram(binwidth=1000000) + 
  labs(x="Income", y="Number") +
  ggtitle("Frequency Distribution of Income")
  
salary_distribution
```

---
EDA: Age
---

```{r}
age_distribution <- ggplot(dd, aes(dd$Age, fill=..count..))+
  geom_histogram(binwidth = 10,) + 
  labs(x="Age", y="Number") +
  ggtitle("Frequency Distribution of Age")+
  scale_x_continuous(breaks = seq(0,250,25))
  
age_distribution
```

---
EDA: House Ownership
---

```{r}
rented_vs_owned <- dd[, .(count = .N), by = House_Ownership]
print(rented_vs_owned)
```

```{r}
ggplot(rented_vs_owned, aes (x="", y = count, fill = House_Ownership)) + 
  geom_col(position = 'stack', width = 1) +
  geom_text(aes(label = paste0(round(count / sum(count) * 100), "%"), x = 1.3),
            position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Blues")+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "House Ownership",
       x = NULL,
       y = NULL,
       title = "House Ownership") + 
  coord_polar("y")

```

---
EDA: Car Ownership
---

```{r}
car_ownership <- dd[, .(count = .N), by = Car_Ownership]
print(car_ownership)
```

```{r}
ggplot(car_ownership, aes (x="", y = count, fill = Car_Ownership)) + 
  geom_col(position = 'stack', width = 1) +
  geom_text(aes(label = paste0(round(count / sum(count) * 100), "%"), x = 1.3),
            position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Blues")+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "Car Ownership",
       x = NULL,
       y = NULL,
       title = "Car Ownership") + 
  coord_polar("y")

```

---
EDA: Marital Status
---

```{r}
marital_status <- dd[, .(count = .N), by = `Married/Single`]
print(marital_status)
```

```{r}
ggplot(marital_status, aes (x="", y = count, fill = `Married/Single`)) + 
  geom_col(position = 'stack', width = 1) +
  geom_text(aes(label = paste0(round(count / sum(count) * 100), "%"), x = 1.3),
            position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Blues")+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "Marital Status",
       x = NULL,
       y = NULL,
       title = "Marital Status") + 
  coord_polar("y")

```

---
EDA: Profession
---

```{r}
profession <- dd[, .(count = .N), by = `Profession`][order(-rank(count))]
print(nrow(profession))
```
```{r}

print(paste0("Disitinct Profession:", nrow(profession)))

```

```{r}

ggplot(data=head(profession,n=10), aes(x=reorder(Profession, count), y=count)) +
  geom_bar(stat="identity")+
  coord_flip()+
  labs(title = 'Top 10 Profession') +
  xlab("Profession")

```

---
Machine learning
---

---
Helper Method
---

```{r}
mse = function(x,y) { mean((x-y)^2)}

```

---
Data Cleaning
---

```{r}
library(data.table)
library(ggplot2)
library(ggthemes)
library(glmnet)
library(dplyr)
theme_set(theme_bw())
```

```{r}
data <- dd

#REMOVE unwanted ID
data$Id <- NULL

#Change col names
colnames(data)[4] <- "Marital_Status"

str(data)
```
```{r}
summary(data)
```

```{r}

set.seed(123)
smp_size <- floor(0.70 * nrow(data))
train_ind <- sample(seq_len(nrow(data)), size = smp_size)

x_data <- model.matrix( ~ -1 + Income + Age +
 Experience + Marital_Status +
 House_Ownership + Car_Ownership + CITY + STATE + Profession + CURRENT_JOB_YRS + CURRENT_HOUSE_YRS, data)

# outcome is median house value in millions
y_data <- dd$Risk_Flag

x_train <- x_data[train_ind, ]
y_train <- y_data[train_ind]
x_test <- x_data[-train_ind, ]
y_test <- y_data[-train_ind]

```

---
Lasso Regression
---

```{r}

lasso_model <- cv.glmnet(x_train, y=y_train, alpha = 1, nfolds = 5)
best_lasso_lambda <- lasso_model$lambda.min


best_model_lasso <- glmnet(x_train, y_train, alpha = 1, lambda = best_lasso_lambda)
#coef(best_model)

predictions_train_lasso <- predict(best_model_lasso, s = best_lasso_lambda, newx = x_train)
predictions_test_lasso <- predict(best_model_lasso, s = best_lasso_lambda, newx = x_test)

print(mse(predictions_test_lasso, y_test))

```

---
Ridge Regression
---



```{r}

ridge_model <- cv.glmnet(x_train, y=y_train, alpha = 0, nfolds = 5)
best_ridge_lambda <- ridge_model$lambda.min


best_model_ridge <- glmnet(x_train, y_train, alpha = 0, lambda = best_ridge_lambda)
#coef(best_model_ridge)

predictions_train_ridge <- predict(best_model_ridge, s = best_ridge_lambda, newx = x_train)
predictions_test_ridge <- predict(best_model_ridge, s = best_ridge_lambda, newx = x_test)

print(mse(predictions_test_ridge, y_test))

```









